# NetProxy 深度审计与缺陷分析报告 (Step 8)

## 1. 概览 (Overview)

经过 Step 7 的修复工作，NetProxy 项目已成功打通了核心链路，解决了严重的集成性故障（如上游代理配置缺失、Tunnel 路由失效等）。目前的版本已具备基本的 TCP 代理、智能路由和内网穿透功能。

然而，以“生产级 (Production Ready)”代理软件的标准进行严格审计后，我们在**网络层能力、路由性能、DNS 策略、安全性及工程化**五个维度发现了显著的不足。这些缺陷虽然不阻碍基础演示，但严重制约了软件在复杂网络环境下的可用性和性能。

本文档详细记录了这些缺陷，作为下一阶段（Step 9 及后续）修复和优化的直接输入。

---

## 2. 核心网络能力缺失 (Core Networking Gaps)

此类缺陷导致软件无法处理特定类型的网络流量，属于**功能性硬伤**。

### 2.1 UDP 代理完全缺失 (Critical)
*   **现状**:
    *   目前所有的 `Dialer` 接口 (`ProxyDialer`, `SmartDialer`) 和协议实现 (`SOCKS5`, `Shadowsocks`) 仅定义并实现了 `TCP` (`net.Conn`) 的连接逻辑。
    *   SOCKS5 协议中的 `UDP Associate` 和 Shadowsocks 中的 `UDP Relay` 逻辑在代码中完全空白。
*   **影响**:
    *   无法代理 **DNS 查询** (UDP 53)，导致必须依赖远程 DoH 或本地直连 DNS。
    *   无法支持 **HTTP/3 (QUIC)** 协议流量。
    *   无法支持 WebRTC (语音/视频通话) 及大量依赖 UDP 的网络游戏流量。

### 2.2 上游代理传输层受限
*   **现状**:
    *   `SmartDialer` 在构建代理链时，底层传输层被硬编码为 `DirectDialer` (直连 TCP)。
    *   虽然 `transport` 包中有 `tls`, `kcp`, `websocket` 的实现，但它们无法被组合用于**连接上游代理**。
*   **缺陷**:
    *   无法配置“连接到 `wss://proxy.example.com` 上的 SOCKS5 服务”这样的场景。
    *   在受限网络环境中（如只能通过 443 端口 TLS 出站），代理节点的连通性大大降低。

---

## 3. 路由模块性能与功能瓶颈 (Router Bottlenecks)

此类缺陷在高并发或复杂规则场景下会引发性能问题。

### 3.1 线性匹配性能低效
*   **现状**:
    *   `SimpleRouter` 使用简单的切片 (`[]Rule`) 存储所有规则。
    *   每次路由判定 (`Route`) 都需要遍历切片进行 O(N) 复杂度的匹配。
*   **缺陷**:
    *   当导入数千条规则（如常见的 `geosite` 大类）时，CPU 消耗将随连接数线性增长。
    *   **改进方向**: 域名匹配应采用 **Trie (基数树)** 或 **HashMap**；IP 匹配应采用 **Interval Tree (区间树)**。

### 3.2 匹配维度单一
*   **现状**:
    *   仅支持 `domain:` (后缀/精确) 和 `geoip:` 两种匹配器。
*   **缺陷**:
    *   缺乏 `CIDR` (自定义 IP 网段，如 `192.168.0.0/16`)。
    *   缺乏 `Port` (目标端口范围)。
    *   缺乏 `Process` (源进程名，需系统调用支持)。

---

## 4. DNS 模块策略缺失 (DNS Policy Gap)

### 4.1 缺乏分流 (Split-Horizon) 能力
*   **现状**:
    *   `internal/feature/dns` 模块仅是一个简单的“接收 -> 转发 -> 缓存 -> 响应”的单一上游转发器。
*   **缺陷**:
    *   无法实现“国内域名向国内 DNS 查询（获取 CDN 优化 IP），国外域名向国外 DoH 查询（防污染）”的策略。
    *   **后果**: 用户体验极差——要么国外域名被污染（直连），要么国内访问变慢（绕路境外 DNS）。

---

## 5. 内网穿透安全性不足 (Tunnel Security)

### 5.1 身份验证薄弱
*   **现状**:
    *   `Tunnel Bridge` (服务端) 和 `Client` (客户端) 之间仅通过明文传输的 `ClientID` 字符串进行“注册”。
*   **缺陷**:
    *   缺乏加密握手机制 (如 mTLS)。
    *   缺乏强认证机制 (如 Token, Secret)。
    *   **风险**: 攻击者可以轻易伪造 ClientID 接入 Bridge，或者窃听控制指令。

---

## 6. 工程化与维护性问题 (Engineering Issues)

### 6.1 配置解析逻辑泄露
*   **现状**: `cmd/netproxy/main.go` 充斥着大量手动解析字符串规则（如 `proxy: domain:...`）和初始化传输层的逻辑。
*   **建议**: 将解析逻辑下沉到 `config` 包或各模块的 `Factory` 方法中，保持 `main` 函数整洁。

### 6.2 资源加载低效
*   **现状**: `SimpleRouter` 在 `AddRule` 时，如果遇到 GeoIP 规则，会重复调用 `geoip2.Open` 打开文件。
*   **建议**: 数据库实例应在 Router 初始化时加载一次并全局共享。

### 6.3 缺乏热重载 (No Hot-Reload)
*   **现状**: 虽然 `viper` 实现了文件监控，但主程序未响应配置变更事件。
*   **影响**: 修改路由规则必须重启服务，导致现有连接中断。
